<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.dromara.hit.mapper.HitUserPortfolioMapper">

    <resultMap type="org.dromara.hit.domain.HitUserPortfolio" id="HitUserPortfolioResult">
        <result property="portfolioId"    column="portfolio_id"    />
        <result property="userId"    column="user_id"    />
        <result property="portfolioTitle"    column="title"    />
        <result property="portfolioDescription"    column="description"    />
        <result property="workType"    column="work_type"    />
        <result property="coverImage"    column="cover_image"    />
        <result property="demoUrl"    column="demo_url"    />
        <result property="repositoryUrl"    column="repository_url"    />
        <result property="downloadUrl"    column="download_url"    />
        <result property="techStack"    column="tech_stack"    />
        <result property="myRole"    column="my_role"    />
        <result property="teamSize"    column="team_size"    />
        <result property="startDate"    column="start_date"    />
        <result property="endDate"    column="end_date"    />
        <result property="viewCount"    column="view_count"    />
        <result property="likeCount"    column="like_count"    />
        <result property="isFeatured"    column="is_featured"    />
        <result property="isPublic"    column="is_public"    />
        <result property="sortOrder"    column="sort_order"    />
        <result property="status"    column="status"    />
        <result property="createDept"    column="create_dept"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="tenantId"    column="tenant_id"    />
    </resultMap>

    <resultMap type="org.dromara.hit.domain.vo.HitUserPortfolioVo" id="HitUserPortfolioVoResult">
        <result property="portfolioId"    column="portfolio_id"    />
        <result property="userId"    column="user_id"    />
        <result property="portfolioTitle"    column="title"    />
        <result property="portfolioDescription"    column="description"    />
        <result property="workType"    column="work_type"    />
        <result property="techStack"    column="tech_stack"    />
        <result property="projectUrl"    column="demo_url"    />
        <result property="repositoryUrl"    column="repository_url"    />
        <result property="videoUrl"    column="video_url"    />
        <result property="coverImage"    column="cover_image"    />
        <result property="portfolioImages"    column="portfolio_images"    />
        <result property="startDate"    column="start_date"    />
        <result property="endDate"    column="end_date"    />
        <result property="teamSize"    column="team_size"    />
        <result property="personalRole"    column="my_role"    />
        <result property="difficulty"    column="difficulty"    />
        <result property="viewCount"    column="view_count"    />
        <result property="likeCount"    column="like_count"    />
        <result property="collectCount"    column="collect_count"    />
        <result property="isTop"    column="is_top"    />
        <result property="orderNum"    column="order_num"    />
        <result property="isFeatured"    column="is_featured"    />
        <result property="isPublic"    column="is_public"    />
        <result property="status"    column="status"    />
        <result property="createTime"    column="create_time"    />
        <result property="nickName"    column="nick_name"    />
        <result property="workTypeLabel"    column="work_type_label"    />
    </resultMap>

    <!-- 查询用户作品集列表（公开展示） -->
    <select id="selectPublicPortfolios" parameterType="Long" resultMap="HitUserPortfolioVoResult">
        SELECT 
            p.portfolio_id,
            p.user_id,
            p.title,
            p.description,
            p.work_type,
            p.tech_stack,
            p.demo_url,
            p.repository_url,
            NULL as video_url,
            p.cover_image,
            NULL as portfolio_images,
            p.start_date,
            p.end_date,
            p.team_size,
            p.my_role,
            NULL as difficulty,
            p.view_count,
            p.like_count,
            NULL as collect_count,
            NULL as is_top,
            p.sort_order as order_num,
            p.is_featured,
            p.is_public,
            p.status,
            p.create_time,
            u.nick_name,
            d.dict_label as work_type_label
        FROM hit_user_portfolio p
        LEFT JOIN sys_user u ON p.user_id = u.user_id
        LEFT JOIN sys_dict_data d ON p.work_type = d.dict_value AND d.dict_type = 'hit_work_type'
        WHERE p.user_id = #{userId} AND p.status = '0'
        ORDER BY p.sort_order ASC, p.create_time DESC
    </select>

    <!-- 根据作品类型查询作品集 -->
    <select id="selectByWorkType" parameterType="String" resultMap="HitUserPortfolioVoResult">
        SELECT 
            p.portfolio_id,
            p.user_id,
            p.title,
            p.description,
            p.work_type,
            p.tech_stack,
            p.demo_url,
            p.repository_url,
            NULL as video_url,
            p.cover_image,
            NULL as portfolio_images,
            p.start_date,
            p.end_date,
            p.team_size,
            p.my_role,
            NULL as difficulty,
            p.view_count,
            p.like_count,
            NULL as collect_count,
            NULL as is_top,
            p.sort_order as order_num,
            p.is_featured,
            p.is_public,
            p.status,
            p.create_time,
            u.nick_name,
            d.dict_label as work_type_label
        FROM hit_user_portfolio p
        LEFT JOIN sys_user u ON p.user_id = u.user_id
        LEFT JOIN sys_dict_data d ON p.work_type = d.dict_value AND d.dict_type = 'hit_work_type'
        WHERE p.work_type = #{workType} AND p.status = '0'
        ORDER BY p.sort_order ASC, p.view_count DESC, p.create_time DESC
    </select>

    <!-- 查询热门作品集（按浏览量排序） -->
    <select id="selectHotPortfolios" parameterType="Integer" resultMap="HitUserPortfolioVoResult">
        SELECT 
            p.portfolio_id,
            p.user_id,
            p.title,
            p.description,
            p.work_type,
            p.tech_stack,
            p.demo_url,
            p.repository_url,
            NULL as video_url,
            p.cover_image,
            NULL as portfolio_images,
            p.start_date,
            p.end_date,
            p.team_size,
            p.my_role,
            NULL as difficulty,
            p.view_count,
            p.like_count,
            NULL as collect_count,
            NULL as is_top,
            p.sort_order as order_num,
            p.is_featured,
            p.is_public,
            p.status,
            p.create_time,
            u.nick_name,
            d.dict_label as work_type_label
        FROM hit_user_portfolio p
        LEFT JOIN sys_user u ON p.user_id = u.user_id
        LEFT JOIN sys_dict_data d ON p.work_type = d.dict_value AND d.dict_type = 'hit_work_type'
        WHERE p.status = '0'
        ORDER BY p.view_count DESC, p.like_count DESC, p.create_time DESC
        LIMIT #{limit}
    </select>

    <!-- 增加浏览次数 -->
    <update id="increaseViewCount" parameterType="Long">
        UPDATE hit_user_portfolio 
        SET view_count = view_count + 1 
        WHERE portfolio_id = #{portfolioId}
    </update>

    <!-- 增加点赞次数 -->
    <update id="increaseLikeCount" parameterType="Long">
        UPDATE hit_user_portfolio 
        SET like_count = like_count + 1 
        WHERE portfolio_id = #{portfolioId}
    </update>

    <!-- 增加收藏次数 -->
    <update id="increaseCollectCount" parameterType="Long">
        UPDATE hit_user_portfolio 
        SET collect_count = collect_count + 1 
        WHERE portfolio_id = #{portfolioId}
    </update>

</mapper> 